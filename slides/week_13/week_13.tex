\documentclass{beamer}
\usetheme{Boadilla}

\makeatother
\setbeamertemplate{footline}
{
    \leavevmode%
    \hbox{%
    \begin{beamercolorbox}[wd=.4\paperwidth,ht=2.25ex,dp=1ex,center]{author in head/foot}%
        \usebeamerfont{author in head/foot}\insertshortauthor
    \end{beamercolorbox}%
    \begin{beamercolorbox}[wd=.55\paperwidth,ht=2.25ex,dp=1ex,center]{title in head/foot}%
        \usebeamerfont{title in head/foot}\insertshorttitle
    \end{beamercolorbox}%
    \begin{beamercolorbox}[wd=.05\paperwidth,ht=2.25ex,dp=1ex,center]{date in head/foot}%
        \insertframenumber{}
    \end{beamercolorbox}}%
    \vskip0pt%
}
\makeatletter
\setbeamertemplate{navigation symbols}{}

\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{amssymb,amsmath,bm,bbm}
\renewcommand{\familydefault}{\sfdefault}

\DeclareMathOperator*{\argmax}{argmax}

\usepackage{mathtools}
\usepackage{graphicx}
\usepackage{threeparttable}
\usepackage{booktabs}
\usepackage{siunitx}
\sisetup{parse-numbers=false}

%\setlength{\OuterFrameSep}{-2pt}
%\makeatletter
%\preto{\@verbatim}{\topsep=-10pt \partopsep=-10pt }
%\makeatother

\title[Week 13:\ Dynamics and Endogeneity]{Week 13:\ Dynamics and Endogeneity}
\author[ResEcon 703:\ Advanced Econometrics]{ResEcon 703:\ Topics in Advanced Econometrics}
\date{Matt Woerman\\University of Massachusetts Amherst}

\begin{document}

{\setbeamertemplate{footline}{} 
\begin{frame}[noframenumbering]
    \titlepage
\end{frame}
}

\begin{frame}\frametitle{Agenda}
    Last week
    \begin{itemize}
        \item Individual-specific coefficients
    \end{itemize}
    \vspace{2ex}
    This week
    \begin{itemize}
    	\item \hyperlink{page.\getpagerefnumber{panel}}{Dynamics}
    	\begin{itemize}
    		\item \hyperlink{page.\getpagerefnumber{panel}}{Static models with panel data}
    		\item \hyperlink{page.\getpagerefnumber{example}}{Dynamic discrete choice example}
    		\item \hyperlink{page.\getpagerefnumber{ddc}}{Dynamic discrete choice models}
    	\end{itemize}
    	\item \hyperlink{page.\getpagerefnumber{endog}}{Endogeneity}
    	\begin{itemize}
    		\item \hyperlink{page.\getpagerefnumber{endog}}{Endogeneity in structural models}
            \item \hyperlink{page.\getpagerefnumber{blp}}{BLP estimation}
            \item \hyperlink{page.\getpagerefnumber{cf}}{Control function model}
    	\end{itemize}
    \end{itemize}
    \vspace{2ex}
    This week's reading
    \begin{itemize}
    	\item Dynamics: Train textbook, chapter 7.7
    	\item Endogeneity: Train textbook, chapter 13
    \end{itemize}
\end{frame}

\section{Static Models with Panel Data}
\label{panel}
\begin{frame}\frametitle{}
    \vfill
    \centering
    \begin{beamercolorbox}[center]{title}
        \Large Static Models with Panel Data
    \end{beamercolorbox}
    \vfill
\end{frame}

\begin{frame}\frametitle{Static Vs.\ Dynamic Models}
    Static structural models
    \begin{itemize}
    	\item An agent maximizes their objective function within the current time period without considering the effect on choices in future time periods
    	\item Some simple ``dynamics'' can be incorporated by including:
    	\begin{itemize}
    		\item Lagged or future explanatory variables
    		\item State dependence through lagged outcome variables
    	\end{itemize}
    	\item All the models we have discussed have been static
    	\item Panel data models can be (and usually are) static
    \end{itemize}
    \vspace{3ex}
    Dynamic structural models
    \begin{itemize}
    	\item An agent maximizes their objective function while explicitly considering the effect on choices in future time periods
    	\begin{itemize}
    		\item A choice in one period may change the choice set in future periods and/or the utility of future choices
    	\end{itemize}
    	\item Modeling this dynamic behavior requires a more complex framework
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Logit Model with Panel Data}
    We can use the logit model to model discrete choices with panel data
    $$U_{njt} = \bm{\beta}' \bm{x}_{njt} + \varepsilon_{njt} \quad \Rightarrow \quad P_{nit} = \frac{e^{\bm{\beta}' \bm{x}_{nit}}}{\sum_j e^{\bm{\beta}' \bm{x}_{njt}}}$$ \\
    \vspace{2ex}
    The logit assumption has to hold
    $$\varepsilon_{njt} \sim \text{i.i.d.\ type I extreme value (Gumbel) with } Var(\varepsilon_{njt}) = \frac{\pi^2}{6}$$ \\
    \begin{itemize}
        \item But the unobserved preferences of a decision maker that affect their choices are unlikely to be independent over time
    \end{itemize}
    \vspace{2ex}
    The logit model with panel data is a sequence of static choices, not a fully dynamic model
    \begin{itemize}
        \item We assume the decision maker maximizes utility in each time period
        \item But we do not represent how a choice will affect future choices
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Mixed Logit Model with Panel Data}
    We can better represent a sequence of choices over time using the mixed logit model
    $$U_{njt} = \bm{\beta}_n' \bm{x}_{njt} + \varepsilon_{njt} \quad \Rightarrow \quad P_{n\bm{i}} = \int \prod_{t = 1}^T \frac{e^{\bm{\beta}' \bm{x}_{ni_{t}t}}}{\sum_{j = 1}^J e^{\bm{\beta}' \bm{x}_{njt}}} f(\bm{\beta} \mid \bm{\theta}) d \bm{\beta}$$ \\
    \vspace{2ex}
    The individual-specific coefficients represent unobserved preferences
    \begin{itemize}
        \item We model these coefficients as random coefficients and estimate their distributions
        \item These individual coefficients yield unobserved correlations in choices over time periods
    \end{itemize}
    \vspace{2ex}
    Although the mixed logit model better represents choices over multiple time periods, it is still inherently a sequence of static choices
    \begin{itemize}
    	\item We do not represent how a choice will affect future choices
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Simple ``Dynamics'' in Static Models}
    When using these static models, we can include lagged outcome variables to model
    \begin{itemize}
        \item Habit formation
        \item Variety-seeking behavior
        \item Switching costs
        \item Brand loyalty
    \end{itemize}
    \vspace{2ex}
    These are all examples of how past choices affect the decision maker's utility in the current time period \\
    \vspace{2ex}
    But if past choices affect utility in the current time period, then the current choice affects future utility
    \begin{itemize}
        \item A rational decision maker will consider these effects on future utility when making the current choice
        \item To fully capture this discrete choice framework, we need to use a dynamic discrete choice model
    \end{itemize}
\end{frame}

\section{Dynamic Discrete Choice Example}
\label{example}
\begin{frame}\frametitle{}
    \vfill
    \centering
    \begin{beamercolorbox}[center]{title}
        \Large Dynamic Discrete Choice Example
    \end{beamercolorbox}
    \vfill
\end{frame}

\begin{frame}\frametitle{Dynamic Discrete Choice Example}
    Why do people attend college? (Or graduate school?)
    \begin{itemize}
        \item Because four years in college provides more utility than anything else the individual could have done in those four years?
        \item Or because college opens up a new set of jobs and higher salaries compared to not attending college?
    \end{itemize}
    \vspace{3ex}
    A static model implicitly assumes that the first answer is correct
    \begin{itemize}
        \item The static model has no good way to represent that the future choice set and salaries will be different after graduating from college
    \end{itemize}
    \vspace{3ex}
    To consider the second answer, we need to use a dynamic discrete choice model
    \begin{itemize}
        \item This model will explicitly represent how the decision to attend college affects the future choice set and salaries
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Decision Maker with Two-Period Dynamics}
    A decision maker thinking about college considers two time periods
    \begin{enumerate}
        \item College ($C$) or work ($W$) for four years
        \begin{itemize}
            \item $U_{1C}$: utility in period 1 from four years in college
            \item $U_{1W}$: utility in period 1 from four years working
        \end{itemize}
        \item A set of $J$ possible jobs for a career over many future years
        \begin{itemize}
            \item $U_{2j}^C$: utility in period 2 from job $j$ after attending college in period 1
            \item $U_{2j}^W$: utility in period 2 from job $j$ after working in period 1
        \end{itemize}
    \end{enumerate}
    \vspace{2ex}
    The total utility obtained from attending college or working in period 1 is
    \begin{align*}
        TU_C & = U_{1C} + \lambda \max_j(U_{2j}^C) \\
        TU_W & = U_{1W} + \lambda \max_j(U_{2j}^W)
    \end{align*}
    where $\lambda$ reflects the relative weighting of the two periods \\
    \vspace{2ex}
    The decision maker attends college if and only if $TU_C > TU_W$
\end{frame}

\begin{frame}\frametitle{Econometrician with Two-Period Dynamics}
    We decompose the utility of each alternative into an observed and an unobserved (to the econometrician) component
    \begin{alignat*}{3}
        U_{1C} & = V_{1C} + \varepsilon_{1C} \qquad && U_{2j}^C && = V_{2j}^C + \varepsilon_{2j}^C \\
        U_{1W} & = V_{1W} + \varepsilon_{1W} \qquad && U_{2j}^W && = V_{2j}^W + \varepsilon_{2j}^W
    \end{alignat*}
    and define $\bm{\varepsilon} = \{\varepsilon_{1C},\varepsilon_{1W}, \varepsilon_{2j}^C, \varepsilon_{2j}^W\}$ with joint density $f(\bm{\varepsilon})$ \\
    \vspace{2ex}
    The probability that the decision maker chooses to attend college is
    \begin{align*}
        P_C & = \Pr(TU_C > TU_W) \\
        & = \int \mathbbm{1} \left[ V_{1C} + \varepsilon_{1C} + \lambda \max_j(V_{2j}^C + \varepsilon_{2j}^C) \right. \\
        &\left. \qquad \qquad > V_{1W} + \varepsilon_{1W} + \lambda \max_j(V_{2j}^W + \varepsilon_{2j}^W)\right] f(\bm{\varepsilon}) d \bm{\varepsilon}
    \end{align*}
    We have to approximate this integral using simulation
\end{frame}

\begin{frame}\frametitle{Simplifications for Two-Period Dynamics}
    If we assume that random utility in the first period, $\varepsilon_{1C}$ and $\varepsilon_{1W}$, is i.i.d.\ extreme value, the choice probability of attending college simplifies to
    $$P_C = \int \frac{e^{V_{1C} + \lambda \max_j(V_{2j}^C + \varepsilon_{2j}^C)}}{e^{V_{1C} + \lambda \max_j(V_{2j}^C + \varepsilon_{2j}^C)} + e^{V_{1W} + \lambda \max_j(V_{2j}^W + \varepsilon_{2j}^W)}} g(\bm{\varepsilon}_2) d \bm{\varepsilon}_2$$
    which is a simpler integral to simulate \\
    \vspace{3ex}
    If we also assume that random utility in the second period, $\varepsilon_{2j}^C$ and $\varepsilon_{2j}^W$, is i.i.d.\ extreme value, the joint probability of attending college in period 1 and then taking job $i$ in period 2 is
    $$P_{Ci} = P_C \times \frac{e^{V_{2i}^C}}{\sum_{j = 1}^J e^{{V_{2j}^C}}}$$
    where $P_C$ is the probability of attending college given above
\end{frame}

\begin{frame}\frametitle{Dynamic Discrete Choice Example With Three Periods}
    After many years working job $j$, the decision maker reaches retirement age and has a new choice to make
    \begin{itemize}
    	\item Continue working full time
    	\item Work part time and spend some retirement funds
    	\item Retire and collect social security and/or pension funds
    \end{itemize}
    \vspace{3ex}
    The retirement plan, social security payout, etc.\ differs for each of the possible jobs in period 2
    \begin{itemize}
    	\item In period 2, the decision maker will consider how their job will affect utility in periods 2 and 3
    	\item In period 1, the decision maker will consider how the decision to attend college will affect utility in all periods
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Decision Maker with Three-Period Dynamics}
    A decision maker thinking about college considers three time periods
    \begin{enumerate}
        \item College ($C$) or work ($W$) for four years
        \item A set of $J$ possible jobs for a career over many future years
        \item A set of $S$ possible retirement plans
        \begin{itemize}
        	\item $U_{3s}^{Cj}$: utility in period 3 from retirement plan $s$ after attending college in period 1 and working job $j$ in period 2
            \item $U_{3s}^{Wj}$: utility in period 3 from retirement plan $s$ after working in period 1 and working job $j$ in period 2
        \end{itemize}
    \end{enumerate}
    \vspace{1ex}
    The total utility obtained from attending college or working in period 1 is
    \begin{align*}
        TU_C & = U_{1C} + \lambda \max_j \left[ U_{2j}^C + \theta \max_s (U_{3s}^{Cj}) \right] \\
        TU_W & = U_{1W} + \lambda \max_j \left[ U_{2j}^W + \theta \max_s (U_{3s}^{Wj}) \right]
    \end{align*}
    where $\lambda$ and $\theta$ reflect the relative weighting of the three periods \\
    \vspace{1ex}
    The decision maker goes to college if and only if $TU_C > TU_W$
\end{frame}

\begin{frame}\frametitle{Econometrician with Three-Period Dynamics}
    We decompose the utility of each alternative into an observed and an unobserved (to the econometrician) component
    \begin{alignat*}{5}
        U_{1C} & = V_{1C} + \varepsilon_{1C} \qquad && U_{2j}^C && = V_{2j}^C + \varepsilon_{2j}^C \qquad && U_{3s}^{Cj} && = V_{3s}^{Cj} + \varepsilon_{3s}^{Cj} \\
        U_{1W} & = V_{1W} + \varepsilon_{1W} \qquad && U_{2j}^W && = V_{2j}^W + \varepsilon_{2j}^W \qquad && U_{3s}^{Wj} && = V_{3s}^{Wj} + \varepsilon_{3s}^{Wj} 
    \end{alignat*}
    and define $\bm{\varepsilon} = \{\varepsilon_{1C},\varepsilon_{1W}, \varepsilon_{2j}^C, \varepsilon_{2j}^W, \varepsilon_{3s}^{Cj}, \varepsilon_{3s}^{Wj}\}$ with joint density $f(\bm{\varepsilon})$ \\
    \vspace{3ex}
    The probability that the decision maker chooses to attend college is
    \begin{align*}
        P_C & = \Pr(TU_C > TU_W) \\
        & = \int \mathbbm{1} \left[ V_{1C} + \varepsilon_{1C} + \lambda \max_j \left[ V_{2j}^C + \varepsilon_{2j}^C + \theta \max_s (V_{3s}^{Cj} + \varepsilon_{3s}^{Cj}) \right] \right. \\
        & \left. \qquad \qquad > V_{1W} + \varepsilon_{1W} + \lambda \max_j \left[ V_{2j}^W + \varepsilon_{2j}^W + \theta \max_s (V_{3s}^{Wj} + \varepsilon_{3s}^{Wj}) \right] \right] \\
        & \qquad \times f(\bm{\varepsilon}) d \bm{\varepsilon}
    \end{align*}
\end{frame}

\section{Dynamic Discrete Choice Models}
\label{ddc}
\begin{frame}\frametitle{}
    \vfill
    \centering
    \begin{beamercolorbox}[center]{title}
        \Large Dynamic Discrete Choice Models
    \end{beamercolorbox}
    \vfill
\end{frame}

\begin{frame}\frametitle{Dynamic Optimization Notation and Terminology}
    Some common notation and terminology for dynamic structural models
    \begin{itemize}
        \item $\{i_1, i_2, \ldots, i_t\}$: sequence of choices up to and including period $t$
        \item $U_{tj}(i_1, i_2, \ldots, i_{t-1})$: utility obtained in period $t$ from alternative $j$, which depends on all previous choices
        \item $TU_{tj}(i_1, i_2, \ldots, i_{t-1})$: total utility (current and all future time periods) obtained from choosing alternative $j$ in period $t$, assuming the optimal choice is made in all future periods
        \begin{itemize}
            \item Known as the ``conditional value function''
        \end{itemize}
        \item $TU_t(i_1, i_2, \ldots, i_{t-1})$: total utility obtained from the optimal choice in period $t$, assuming the optimal choice is made in all future periods
        \begin{itemize}
            \item $TU_t(i_1, i_2, \ldots, i_{t-1}) = \max_j TU_{tj}(i_1, i_2, \ldots, i_{t-1})$
            \item Known as the ``value function'' or ``valuation function'' at time $t$
        \end{itemize}
    \end{itemize}
    \vspace{3ex}
    We need to calculate all possible values of $TU_{tj}(i_1, \ldots, i_{t-1})$ in order to express the optimal choice in each time period
\end{frame}

\begin{frame}\frametitle{Bellman Equation for Dynamic Discrete Choice}
    The decision maker chooses optimally (maximizes utility) in the current period knowing they will also choose optimally in every future period (and discounting the future with discount rate $\delta$), which yields an expression for the value function at time $t$
    $$TU_t(i_1, \ldots, i_{t-1}) = \max_j \left[ U_{tj}(i_1, \ldots, i_{t-1}) + \delta TU_{t+1}(i_1, \ldots, i_t = j) \right]$$
    This relation is the Bellman equation for dynamic discrete choice \\
    \vspace{3ex}
    We can also write down a Bellman equation for the conditional valuation function, $TU_{tj}(i_1, \ldots, i_{t-1})$
    $$TU_{tj}(i_1, \ldots, i_{t-1}) = U_{tj}(i_1, \ldots, i_{t-1}) + \delta \max_k \left[ TU_{t+1,k}(i_1, \ldots, i_t = j) \right]$$
\end{frame}

\begin{frame}\frametitle{Applying the Bellman Equation}
    If the number of time periods is finite, we can apply the Bellman equation through backward recursion to calculate all possible $TU_{tj}(i_1, \ldots, i_{t-1})$
    \begin{enumerate}
        \item Start in the last time period, $t = T$, with
        $$TU_{Tj}(i_1, \ldots, i_{T-1}) = U_{Tj}(i_1, \ldots, i_{T-1})$$
        \item Calculate total utility in period $T - 1$, $TU_{T-1j}(i_1, \ldots, i_{T-2})$, as a function of the values of $TU_{Tj}(i_1, \ldots, i_{T-1})$ from step 1
        \item Continue working backward until you reach period 1
    \end{enumerate}
    \vspace{3ex}
    We have to calculate $U_{tj}(i_1, \ldots, i_{t-1})$ for each $t$, each $j$, and each $\{i_1, i_2, \ldots, i_{t-1}\}$
    \begin{itemize}
        \item If there are $J$ alternatives in each of $T$ time periods, we have to calculate $J^T \times T$ utilities
        \item This computational burden is known as the ``curse of dimensionality''
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Choice Probabilities in Dynamic Discrete Choice}
    We will ultimately use these conditional value functions, $TU_{tj}(i_1, \ldots, i_{t-1})$, to create an expression for choice probabilities \\
    \vspace{3ex}
    For example, the probability of choosing alternative $i$ in period 1 is
    \begin{align*}
        P_{1i} & = \Pr(TU_{1i} > TU_{1j} \; \forall j \neq i) \\
        & = \int \mathbbm{1} \left[ TU_{1i}(\bm{\varepsilon}) > TU_{1j}(\bm{\varepsilon}) \; \forall j \neq i \right] f(\bm{\varepsilon}) d \bm{\varepsilon}
    \end{align*} \\
    \vspace{3ex}
    We have to simulate this choice probability by taking random draws from an assumed joint density of all unobserved utilities, $f(\bm{\varepsilon})$ \\
    \vspace{3ex}
    See chapter 7.7.3 of the Train textbook for more details
\end{frame}

\begin{frame}\frametitle{Uncertainty in Dynamic Discrete Choice Models}
    So far we have assumed that the decision maker has perfect information about the future
    \begin{itemize}
        \item Utility of each alternative in each future time period
        \item How every possible sequence of choices affects this future utility
        \item But this is unlikely to be true!
    \end{itemize}
    \vspace{2ex}
    We can model utility as a function of factors that are unknown in previous periods
    \begin{itemize}
        \item The decision maker maximizes total expected utility with the expectation taken over the density of the unknown factors
        \item This expectation adds another integral that has to be simulated, adding yet another layer of complexity and dimensionality to a problem that already suffers from the curse of dimensionality
    \end{itemize}
    \vspace{2ex}
    See chapter 7.7.3 of the Train textbook for more details
\end{frame}

\begin{frame}\frametitle{Simplifications for Dynamic Discrete Choice Models}
    Use the fewest number of time periods possible
    \begin{itemize}
        \item We could model the college-job-retirement sequence of choices annually (or monthly, weekly, daily) instead of three broad time periods
        \item Estimation is feasible with three time periods, but it becomes (at least) an order of magnitude more difficult with 60 individual year
    \end{itemize}
    \vspace{2ex}
    Assume the factors that the decision maker does not observe are the same factors that the econometrician does not observe, and these factors are i.i.d.\ extreme value
    \begin{itemize}
        \item Choice probabilities have closed-form expressions that are easy to calculate
        \item This assumption is unrealistic, but it may be the only way to make the model tractable
    \end{itemize}
    \vspace{2ex}
    See chapter 7.7.3 of the Train textbook for more details
\end{frame}

\section{Endogeneity in Structural Models}
\label{endog}
\begin{frame}\frametitle{}
    \vfill
    \centering
    \begin{beamercolorbox}[center]{title}
        \Large Endogeneity in Structural Models
    \end{beamercolorbox}
    \vfill
\end{frame}

\begin{frame}\frametitle{Endogeneity in Structural Models}
    So far, we have (mostly) assumed that all of our explanatory variables are exogenous
    \begin{itemize}
        \item When we talked about GMM estimation, we talked how we can use it to incorporate instruments, but I did not say much about why we would want to do so
    \end{itemize}
    \vspace{3ex}
    Why is exogeneity/endogeneity so important?
    \begin{itemize}
        \item We need exogenous variation in our explanatory variables in order to give our parameter estimates a ``causal'' interpretation
        \begin{itemize}
        	\item If the data are endogenous, our parameters can be interpreted as a kind of correlation between the data and choices, but they will not be the true structural parameters we intend to estimate
        \end{itemize}
        \item But in most cases, exogenous variation in the explanatory variables is difficult to come by
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Examples of Endogeneity}
    Housing choice and commute choice are correlated
    \begin{itemize}
        \item Example: people who like public transit tend to live closer to transit stations, making their transit travel time lower
        \item The coefficient on transit travel time will be biased upward
    \end{itemize}
    \vspace{2ex}
    Price and unobserved quality are correlated
    \begin{itemize}
        \item Example: products with higher unobserved (to the econometrician) quality cost more and are preferred by consumers
        \item The coefficient on price will be biased downward and may even have the wrong sign
    \end{itemize}
    \vspace{2ex}
    Price and unobserved marketing are correlated
    \begin{itemize}
        \item Example: large marketing campaigns may be accompanied by sales or increased prices
        \item The coefficient on price will be biased, but the direction is uncertain
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Exogenous Variation and Causal Parameters}
    How do we estimate parameters with a ``causal'' interpretation?
    \begin{itemize}
    	\item BLP estimation: use instruments to isolate exogenous variation in explanatory variables
    	\item Control function estimation: use instruments to control for endogeneity in explanatory variables
    \end{itemize}
    \vspace{2ex}
    What makes a good instrument?
    \begin{itemize}
    	\item Correlated with explanatory variables
    	\item Exogenous, or uncorrelated with random utility
    \end{itemize}
    \vspace{2ex}
    Where do we get good instruments?
    \begin{itemize}
    	\item Same concept as good research design for reduced-form analysis
    	\begin{itemize}
    		\item Institutional knowledge, natural experiments, etc.
    	\end{itemize}
    \end{itemize}
\end{frame}

\section{BLP Estimation}
\label{blp}
\begin{frame}\frametitle{}
    \vfill
    \centering
    \begin{beamercolorbox}[center]{title}
        \Large BLP Estimation
    \end{beamercolorbox}
    \vfill
\end{frame}

\begin{frame}\frametitle{BLP Estimation}
    The context for the canonical BLP estimation approach is a mixed logit (or random coefficients) model of demand for a differentiated product using market-level data
    \begin{itemize}
        \item We want to estimate how the attributes of a product affect consumer demand
        \item Price is (one of) the most important attributes to consider
        \item But price is almost certainly correlated with the unobserved attributes (quality, etc.) of a product
    \end{itemize}
    \vspace{2ex}
    Berry, Levinsohn, and Pakes (1995)---known as BLP---use instruments to isolate exogenous variation in price
    \begin{itemize}
        \item This paper developed a novel method to include instruments in a nonlinear model using market-level data
    \end{itemize}
    \vspace{2ex}
    A similar procedure can be used for endogenous variables other than price
\end{frame}

\begin{frame}\frametitle{BLP Demand Model}
    We have data on $M$ markets with $J$ products in each market
    \begin{itemize}
        \item One of these products can be the ``outside good'' or purchase nothing
    \end{itemize}
    \vspace{3ex}
    The utility that consumer $n$ in market $m$ obtains from product $j$ is
    $$U_{njm} = V(p_{jm}, \bm{x}_{jm}, \bm{s}_n, \bm{\beta}_n) + \xi_{jm} + \varepsilon_{njm}$$ \\
    \vspace{-1ex}
    \begin{itemize}
        \item $p_{jm}$: price of product $j$ in market $m$
        \item $\bm{x}_{jm}$: vector of non-price attributes of product $j$ in market $m$
        \item $\bm{s}_n$: vector of demographic characteristics of consumer $n$
        \item $\bm{\beta}_n$: vector of coefficients for consumer $n$
        \item $\xi_{jm}$: utility of unobserved attributes of product $j$ in market $m$
        \item $\varepsilon_{njm}$: idiosyncratic unobserved utility
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Endogeneity in the BLP Demand Model}
    We would expect the price to depend on all attributes of a product, including those that are unobserved by the econometrician
    \begin{itemize}
        \item But if consumers also get utility from those unobserved attributes, then the price is correlated with the composite error term, $\xi_{jm} + \varepsilon_{njm}$
    \end{itemize}
    \vspace{3ex}
    To solve this problem, BLP use a two-step procedure
    \begin{enumerate}
        \item Estimate the average utility for product $j$ in market $m$, including observable and unobservable attributes
        \item Regress this average utility value on price and other observable attributes, instrumenting for price 
    \end{enumerate}
\end{frame}

\begin{frame}\frametitle{Utility Decomposition}
    Decompose the utility from observed attributes, $V(p_{jm}, \bm{x}_{jm}, \bm{s}_n, \bm{\beta}_n)$, into two components (with $\bar{\beta}$ and $\widetilde{\beta}_n$ defined analogously)
    \begin{itemize}
        \item $\bar{V}(p_{jm}, \bm{x}_{jm}, \bar{\bm{\beta}})$: component that varies over products and markets
        \item $\widetilde{V}(p_{jm}, \bm{x}_{jm}, \bm{s}_n, \widetilde{\bm{\beta}}_n)$: component that varies by consumer
    \end{itemize}
    \vspace{2ex}
    Then the utility that consumer $n$ in market $m$ obtains from product $j$ is
    \begin{align*}
        U_{njm} & = \bar{V}(p_{jm}, \bm{x}_{jm}, \bar{\bm{\beta}}) + \widetilde{V}(p_{jm}, \bm{x}_{jm}, \bm{s}_n, \widetilde{\bm{\beta}}_n) + \xi_{jm} + \varepsilon_{njm} \\
        & = \left[ \bar{V}(p_{jm}, \bm{x}_{jm}, \bar{\bm{\beta}}) + \xi_{jm} \right] + \widetilde{V}(p_{jm}, \bm{x}_{jm}, \bm{s}_n, \widetilde{\bm{\beta}}_n) + \varepsilon_{njm} \\
        & = \delta_{jm} + \widetilde{V}(p_{jm}, \bm{x}_{jm}, \bm{s}_n, \widetilde{\bm{\beta}}_n) + \varepsilon_{njm} \\
        \intertext{where}
        \delta_{jm} & = \bar{V}(p_{jm}, \bm{x}_{jm}, \bar{\bm{\beta}}) + \xi_{jm}
    \end{align*} \\
    This term, $\delta_{jm}$, effectively becomes a product-market constant term that represents the average utility obtained by product $j$ in market $m$
\end{frame}

\begin{frame}\frametitle{Choice Probabilities}
    Two distributional assumptions
    \begin{itemize}
        \item $\varepsilon_{njm} \sim$ i.i.d.\ type I extreme value
        \item $\widetilde{\bm{\beta}}_n$ has density $f(\widetilde{\bm{\beta}}_n \mid \bm{\theta})$
        \begin{itemize}
            \item The mean of $\bm{\beta}_n$ is already modeled by $\bar{\bm{\beta}}$, so $\bm{\theta}$ will often be only a variance-covariance matrix
        \end{itemize}
    \end{itemize}
    \vspace{2ex}
    Then choice probabilities can be expressed as functions of $\delta_{jm}$ and $\widetilde{V}(\cdot)$
    $$P_{nim} = \int \left[ \frac{e^{\delta_{im} + \widetilde{V}(p_{im}, \bm{x}_{im}, \bm{s}_n, \widetilde{\bm{\beta}}_n)}}{\sum_{j = 1}^{J} e^{\delta_{jm} + \widetilde{V}(p_{jm}, \bm{x}_{jm}, \bm{s}_n, \widetilde{\bm{\beta}}_n)}} \right] f(\widetilde{\bm{\beta}}_n \mid \bm{\theta}) d \widetilde{\bm{\beta}}_n$$ \\
    \vspace{2ex}
    We can use these choice probabilities to estimate the constant terms, $\delta_{jm}$, and the $\bm{\theta}$ parameters
    \begin{itemize}
        \item But we cannot directly estimate the $\bar{\bm{\beta}}$ parameters because they are subsumed into the constant terms
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Instrumenting for Price}
    If we assume that $\bar{V}$ is linear in parameters
    $$\bar{V}(p_{jm}, \bm{x}_{jm}, \bar{\bm{\beta}}) = \bar{\bm{\beta}}' (p_{jm}, \bm{x}_{jm})$$
    then we can express the constant terms as
    $$\delta_{jm} = \bar{\bm{\beta}}' (p_{jm}, \bm{x}_{jm}) + \xi_{jm}$$ \\
    \vspace{3ex}
    Once we have estimated the constant terms, we can regress them on prices and other attributes to estimate $\bar{\bm{\beta}}$
    \begin{itemize}
        \item But price is endogenous---it depends on $\xi_{jm}$---so we have to instrument for price in this regression
        \item Instrumenting in a linear model is easy if we have good instruments
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Contraction Mapping}
    This estimation framework is theoretically feasible
    \begin{itemize}
        \item But we have to estimate $\delta_{jm}$ for each product and market, which can easily be 100s or 1000s (or more!) of terms to estimate
    \end{itemize}
    \vspace{2ex}
    BLP developed an alternate approach that does not require estimating these $\delta_{jm}$ terms in the standard way
    \begin{itemize}
        \item Their insight is that these $\delta_{jm}$ terms determine predicted market shares, so we want to find the set of constant terms that equates predicted market shares with observed market shares
    \end{itemize}
    \vspace{2ex}
    BLP show that
    \begin{itemize}
        \item For a given set of $\bm{\theta}$ parameters, a unique vector $\bm{\delta}$ equates predicted market shares with observed market shares
        \item There is an iterative ``contraction mapping'' algorithm that recovers this unique vector of $\bm{\delta}$
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Contraction Mapping Algorithm}
    We want to find the vector of product-market constant terms, $\bm{\delta}$, that equates predicted market share, $\widehat{S}_{jm}(\bm{\delta})$, with observed market share, $S_{jm}$, for all products in all markets
    \begin{enumerate}
        \item Begin with some initial product-market constant values, $\bm{\delta}^0$
        \item Predict the market share for the current constant values, $\widehat{S}_{jm}(\bm{\delta}^s)$, for each product-market
        \item Adjust each product-market constant term by comparing predicted and observed market share
        $$\delta_{jm}^{s+1} = \delta_{jm}^s + \ln \left( \frac{S_{jm}}{\widehat{S}_{jm}(\bm{\delta}^s)} \right)$$
        \item Repeat steps (2) and (3) until the algorithm converges to the set of product-market constants, $\widehat{\bm{\delta}}$
    \end{enumerate}
\end{frame}

\begin{frame}\frametitle{Estimation}
    The contraction mapping is an inner algorithm loop within the larger estimation loop \\
    \vspace{2ex}
    Two steps to estimate this model
    \begin{enumerate}
        \item Outer loop: search over $\bm{\theta}$ to optimize the estimation objective function
        \begin{enumerate}
            \item Inner loop: use the contraction mapping to find $\bm{\delta}(\bm{\theta})$, the vector of product-market constant terms conditional on $\bm{\theta}$
            \item Use $\bm{\theta}$ and $\bm{\delta}(\bm{\theta})$ to simulate choice probabilities, $\check{P}_{njm}(\bm{\delta}(\bm{\theta}), \bm{\theta})$
            \item Use choice probabilities to calculate the estimation objective function
        \end{enumerate}
        \item Estimate $\bar{\bm{\beta}}$ by regressing $\delta_{jm}$ on $(p_{jm}, \bm{x}_{jm})$ with price instruments, $\bm{z}_{jm}$
    \end{enumerate}
    \vspace{2ex}
    We can estimate this model in two different ways
    \begin{itemize}
        \item MSL for step 1 and 2SLS for step 2
        \item MSM for steps 1 and 2 simultaneously
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{BLP Estimation Using MSL and 2SLS}
    The MSL estimator, $\widehat{\bm{\theta}}$, is the set of parameters that maximizes the simulated log-likelihood function
    \begin{align*}
    	\widehat{\bm{\theta}} & = \argmax_{\bm{\theta}} \sum_{n = 1}^N \ln \check{P}_{ni_nm}(\bm{\theta})
    	\intertext{and this estimator implies a unique vector of product-market constants}
    	\widehat{\bm{\delta}} & = \bm{\delta}(\widehat{\bm{\theta}})
    	\intertext{Then $\bar{\bm{\beta}}$ is estimated by regressing $\widehat{\delta}_{jm}$ on $(p_{jm}, \bm{x}_{jm})$ by 2SLS}
    	\widehat{\delta}_{jm} & = \bar{\bm{\beta}}' (p_{jm}, \bm{x}_{jm}) + \xi_{jm}
    	\intertext{with exogenous instruments $\bm{z}_{jm}$, which gives thes 2SLS estimator}
    	\widehat{\bar{\bm{\beta}}} & = \left( \sum_{j = 1}^{J} \sum_{m = 1}^M \bm{z}_{jm} (p_{jm}, \bm{x}_{jm}) \right)^{-1} \left( \sum_{j = 1}^{J} \sum_{m = 1}^M \bm{z}_{jm} \widehat{\delta}_{jm} \right)
    \end{align*}
\end{frame}

\begin{frame}\frametitle{BLP Estimation Using MSM}
    The population moments that correspond to the two steps of BLP estimation, respectively, are
    \begin{align*}
    	E \left[ \left( y_{njm} - \check{P}_{njm}(\bm{\theta}) \right) \bm{z}_{njm} \right] & = \bm{0} \\
    	E \left[ \left( \delta_{jm}(\bm{\theta}) - \bar{\bm{\beta}}' (p_{jm}, \bm{x}_{jm}) \right) \bm{z}_{jm} \right] & = \bm{0}
    	\intertext{The MSM estimator, $(\widehat{\bm{\theta}}, \widehat{\bar{\bm{\beta}}})$ is the set of parameters that solves the empirical analogs of these population moments}
    	\frac{1}{NJ} \sum_{n = 1}^N \sum_{j = 1}^J \left( y_{njm} - \check{P}_{njm}(\widehat{\bm{\theta}}) \right) \bm{z}_{njm} & = \bm{0} \\
    	\frac{1}{JM} \sum_{j = 1}^J \sum_{m = 1}^M \left( \delta_{jm}(\widehat{\bm{\theta}}) - \widehat{\bar{\bm{\beta}}}' (p_{jm}, \bm{x}_{jm}) \right) \bm{z}_{jm} & = \bm{0}
    \end{align*}
    or minimizes the weighted sum of squared moments
\end{frame}

\section{Control Function Model}
\label{cf}
\begin{frame}\frametitle{}
    \vfill
    \centering
    \begin{beamercolorbox}[center]{title}
        \Large Control Function Model
    \end{beamercolorbox}
    \vfill
\end{frame}

\begin{frame}\frametitle{Control Function Approach}
    The control function approach can be thought of as the opposite of the BLP approach
    \begin{itemize}
        \item The BLP approach isolates exogenous variation
        \item The control function approach controls for the source of endogeneity
    \end{itemize}
    \vspace{3ex}
    Why might the control function approach be better than the BLP approach?
    \begin{itemize}
        \item A control function can be used even if market shares are zero
        \begin{itemize}
            \item The constant terms in BLP are not identified for zero market shares
        \end{itemize}
        \item A control function can control for individual-level endogeneity, rather than market-level endogeneity
        \begin{itemize}
            \item An individual-specific constant term is not identified in BLP
        \end{itemize}
        \item The control function approach does not require the contraction mapping
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Control Function Model}
    The utility that consumer $n$ obtains from product $j$ is
    $$U_{nj} = V(y_{nj}, \bm{x}_{nj}, \bm{\beta}_n) + \varepsilon_{nj}$$
    \vspace{-3ex}
    \begin{itemize}
        \item $y_{nj}$: endogenous explanatory variable for consumer $n$ and product $j$
        \item $\bm{x}_{jm}$: vector of non-price attributes for consumer $n$ and product $j$
        \item $\bm{\beta}_n$: vector of coefficients for consumer $n$
        \item $\varepsilon_{nj}$: unobserved utility for consumer $n$ and product $j$
    \end{itemize}
    \vspace{2ex}
    The endogenous explanatory variable can be expressed as
    $$y_{nj} = W(\bm{z}_{nj}, \bm{\gamma}) + \mu_{nj}$$
    \vspace{-3ex}
    \begin{itemize}
        \item $\bm{z}_{nj}$: vector of exogenous instruments for $y_{nj}$
        \item $\bm{\gamma}$: parameters that relate $y_{nj}$ and $\bm{z}_{nj}$
        \item $\mu_{nj}$: unobserved factors that affect $y_{nj}$
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Endogeneity in the Control Function Model}
    The utility that consumer $n$ obtains from product $j$ is
    \begin{align*}
        U_{nj} & = V(y_{nj}, \bm{x}_{nj}, \bm{\beta}_n) + \varepsilon_{nj} \\
        \intertext{where the endogenous variable, $y_{nj}$, can be expressed as}
        y_{nj} & = W(\bm{z}_{nj}, \bm{\gamma}) + \mu_{nj}
    \end{align*} \\
    \vspace{3ex}
    Two assumptions about the model errors
    \begin{itemize}
        \item $\varepsilon_{nj}$ and $\mu_{nj}$ are correlated
        \begin{itemize}
            \item $y_{nj}$ and $\varepsilon_{nj}$ are correlated, so $y_{nj}$ is endogenous
        \end{itemize}
        \item $\varepsilon_{nj}$ and $\mu_{nj}$ are independent of $\bm{z}_{nj}$
        \begin{itemize}
            \item $\bm{z}_{nj}$ are good instruments for $y_{nj}$
        \end{itemize}
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Control Function}
    Decompose the unobserved utility, $\varepsilon_{nj}$, into a conditional mean and a deviation from this conditional mean
    $$\varepsilon_{nj} = E[\varepsilon_{nj} \mid \mu_{nj}] + \widetilde{\varepsilon}_{nj}$$ \\
    \vspace{2ex}
    By construction, the deviations are not correlated with $\mu_{nj}$, so they are not correlated with $y_{nj}$
    \begin{itemize}
        \item If we can control for the conditional mean, then we control for the source of endogeneity
    \end{itemize}
    \vspace{2ex}
    We construct a ``control function'' to control for the conditional mean
    $$CF(\mu_{nj}, \bm{\lambda}) = E[\varepsilon_{nj} \mid \mu_{nj}]$$
    \vspace{-3ex}
    \begin{itemize}
        \item The control function is often linear, $CF(\mu_{nj}, \lambda) = \lambda \mu_{nj}$
    \end{itemize}
\end{frame}

\begin{frame}\frametitle{Control Function Choice Probabilities}
    Substituting in the control function, the utility that consumer $n$ obtains from product $j$ becomes
    $$U_{nj} = V(y_{nj}, \bm{x}_{nj}, \bm{\beta}_n) + CF(\mu_{nj}, \bm{\lambda}) + \widetilde{\varepsilon}_{nj}$$ \\
    \vspace{3ex}
    We make two distributional assumptions
    \begin{itemize}
        \item $\widetilde{\bm{\varepsilon}}_n$ has conditional density $g(\widetilde{\bm{\varepsilon}}_n \mid \bm{\mu}_n)$
        \item $\bm{\beta}_n$ has density $f(\bm{\beta}_n \mid \bm{\theta})$
    \end{itemize}
    \vspace{3ex}
    Then the choice probabilities are
    \begin{align*}
        P_{ni} & = \int \int \mathbbm{1} \left[ V_{ni} + CF_{ni} + \widetilde{\varepsilon}_{ni} > V_{nj} + CF_{nj} + \widetilde{\varepsilon}_{nj} ~ \forall j \neq i \right] \\
        & \qquad \quad ~~ \times g(\widetilde{\bm{\varepsilon}}_n \mid \bm{\mu}_n) f(\bm{\beta}_n \mid \bm{\theta}) d \widetilde{\bm{\varepsilon}}_n d \bm{\beta}_n
    \end{align*}
\end{frame}

\begin{frame}\frametitle{Control Function Estimation}
    Two steps to estimate this model
    \begin{enumerate}
        \item Estimate $\widehat{\mu}_{nj}$ by regressing $y_{nj}$ on $\bm{z}_{nj}$
        \begin{itemize}
            \item $\widehat{\mu}_{nj}$ is the residual of this regression
        \end{itemize}
        \item Estimate $(\widehat{\bm{\theta}}, \widehat{\bm{\lambda}})$ by MSL using simulated choice probabilities to construct a simulated log-likelihood function
    \end{enumerate}
    \vspace{3ex}
    An alternative approach is to estimate all parameters simultaneously
    \begin{itemize}
        \item This approach requires that we specify the joint distribution of $\bm{\varepsilon}_n$ and $\bm{\mu}_n$, whereas the sequential method requires only the conditional distribution of $\bm{\varepsilon}_n$ given $\bm{\mu}_n$
        \item But if we can correctly specify this joint distribution, then the simultaneous approach is more efficient
    \end{itemize}
\end{frame}

\end{document}